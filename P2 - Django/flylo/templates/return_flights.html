{% extends 'base.html' %}


{% block style %}
	<style>
		.table td:first-child {
			border-right: 2px solid gray;
		}

		input[type=checkbox] {
			/* Double-sized Checkboxes */
			-ms-transform: scale(1.5); /* IE */
			-moz-transform: scale(1.5); /* FF */
			-webkit-transform: scale(1.5); /* Safari and Chrome */
			-o-transform: scale(1.5); /* Opera */
			padding: 10px;
		}

		.table td {
			text-align: center;
		}

		.table th {
			text-align: center;
		}

	</style>
{% endblock %}


{% block content %}
{% if flights %}
	<form action="{% url 'flylo:shoppingcart' %}" method="post">
		{% csrf_token %}

		{% for flight in flights %}
		<h1>Return flights for {{flight.flight_number}}:</h1>

            <table class="table table-striped table-hover table-responsive">
                <thead>
                <tr>
					<th>Add to Cart</th>
					<th>Departure</th>
					<th>Arrival</th>
					<th>Flight No.</th>
					<th>Airline</th>
					<th>No. Seats</th>
					<th>Class</th>
					<th>Price</th>
				</tr>
                </thead>

                {% for flight in flight.return_flights %}
                    <tr id="flight{{ flight.id }}">

						<td>

							<div class="">
								<input type="checkbox" id="selected_going{{ flight.id }}"
									   name="selected_going{{ flight.id }}" value="{{ flight.id }}"
									   class="">
							</div>
						</td>


						<td class="h4"><b class="label label-primary">{{ flight.location_departure }}</b></td>
						<td class="h4"><b class="label label-primary">{{ flight.location_arrival }}</b></td>

						<td><a href="{% url 'flylo:flights' pk %}{{ flight.id }}">
							{{ flight.flight_number }} ({{ flight.pk }})</a></td>
						<td>
							<select name="airline{{ flight.id }}" class="form-control input-sm">
								{% for a in flight.airlines.all %}
									<option value="{{ a }}">{{ a }}</option>
								{% endfor %}
							</select>
						</td>

						<td class="center">
							<select class="form-control input-sm" name="seats{{ flight.id }}">
								<option value="1">1 Seat</option>
								<option value="2">2 Seats</option>
								<option value="3">3 Seats</option>
								<option value="4">4 Seats</option>
								<option value="5">5 Seats</option>
							</select>
						</td>

						<td class="center">
							<select name="type{{ flight.id }}" class="form-control input-sm">
								<option value='e'>Economy</option>
								<option value='b'>Business</option>
								<option value='f'>First Class</option>
							</select>
						</td>

						<td class="h4">
							<span class="label label-warning" id="price">00.00€</span>
						</td>

					</tr>
                {% endfor %}
            </table>
		{% endfor %}

        <input type="submit" class="btn btn-primary pull-right" value="Go to Shopping Cart">
    </form>
{% else %}
    <p>No flights are available.</p>
{% endif %}

    <div class="clearfix"></div>
	<hr>

	<div id="app">
		<div v-for="f in flights" class="well">
			${f.flight_number} : ${f.price}&euro;
		</div>
	</div>

{% endblock %}


{% block scripts %}

	<script type="text/javascript">

        var csrf = '{{ csrf_token }}';

        $(document).ready(function () {


            $("[id^=flight]").each(function (i, e) {

                e = $(e);
                getPrice(1, 1, 1, 'e', function (data) {
                    e.find("#price").text(data + "€")
                });

            });

            $("[name^=seats]").change(function (e) {
                var row = $(e.target).parent().parent()
                var nseats = row.find("[name^=seats]").val()
                var type = row.find("[name^=type]").val()
                //row.find("#price").text(nseats * 50 + ".00€")

                getPrice(1, 1, nseats, type, function (data) {
                    row.find("#price").text(data + "€")
                });

            });

        });

        getPrice = function (fid, aid, nseats, type, callback) {
            $.ajax({
                url: 'http://localhost:8080/flylo/api/price/' + fid + '/' + aid + '/' + nseats + '/' + type,
                type: 'GET',
                data: {
                    'csrfmiddlewaretoken': csrf
                },
                success: function (data) {
                    callback(data)
                }
            })
        }

        vue = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                departure: '{{ departure }}',
                flights: []
            },
            methods: {
                updateFlights: function () {
                    url = 'http://localhost:8080/api/flights';
                    if (this.departure)
                        url += '?departure='+this.departure;

                    $.get(url, function (data) {
                        vue.flights = data
                    });
                }
            },
            created: function () {
				//this.updateFlights()
            }

        });

	</script>

{% endblock %}